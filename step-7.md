# Знакомство с RabbitMQ

Иногда есть необходимость обрабатывать входящие задачи в отложенном режиме и тогда приходится использовать [системы очередей](https://en.wikipedia.org/wiki/Message_queue). Одним из самых распространненых инструментов для организации системы очередей является [RabbitMQ](https://www.rabbitmq.com/). 

Для прогружения в теорию работы системы очередей необходимо прочитать следющие статьи:
 - [RabbitMQ tutorial 1 — Hello World](https://habr.com/ru/post/149694/)
 - [RabbitMQ tutorial 2 — Очередь задач](https://habr.com/ru/post/150134/)

## Выполнение задания

Нам необходимо добавить поддержку записей трат денежных средств по средством обработки сообщений приходящих в RabbitMQ. Для этого необходимо:

- установка RabbitMQ
- создание клиента который может записывать данные в очередь 
- создание обработчика который может считывать данные из очереди

### Создание клиента для записи данных

В папке с проектом сосздайте папку `fin_client` и добавьте туда файл `build.gradle` со следующим содержанием:

```groovy
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.0.5.RELEASE")
    }
}

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
    baseName = 'fin_client'
    version =  '0.1.0'
}

repositories {
    mavenCentral()
}

sourceCompatibility = 1.11
targetCompatibility = 1.11

dependencies {
    testCompile("junit:junit")
}

```

А в файле `settings.gradle` находящий в корне проекта добавьте строку `fin_client`, что бы файл выглядел так:

```groovy
/*
 * This file was generated by the Gradle "init" task.
 *
 * The settings file is used to specify which projects to include in your build.
 *
 * Detailed information about configuring a multi-project build in Gradle can be found
 * in the user guide at https://docs.gradle.org/4.10.2/userguide/multi_project_builds.html
 */

rootProject.name = "Personal_finance"
include "fin_client"
```

Добавьте в зависимочти следующую библиотеку Spring `compile("org.springframework.boot:spring-boot-starter-amqp")`, в итоге `build.gradle` должен выглядеть следующим образом:

```groovy
buildscript {
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath("org.springframework.boot:spring-boot-gradle-plugin:2.0.5.RELEASE")
    }
}

apply plugin: 'java'
apply plugin: 'idea'
apply plugin: 'org.springframework.boot'
apply plugin: 'io.spring.dependency-management'

bootJar {
    baseName = 'fin_client'
    version =  '0.1.0'
}

repositories {
    mavenCentral()
}

sourceCompatibility = 1.11
targetCompatibility = 1.11

dependencies {
    compile("org.springframework.boot:spring-boot-starter-amqp")
    testCompile("junit:junit")
}
```

Создайте главный файл для запуска приложения:

```java
package io.github.personal_finance;

import org.springframework.amqp.core.Binding;
import org.springframework.amqp.core.BindingBuilder;
import org.springframework.amqp.core.Queue;
import org.springframework.amqp.core.TopicExchange;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.context.annotation.Bean;

@SpringBootApplication
public class Application {
    // Имя обменника
    static final String topicExchangeName = "personal-finance";
    // Имя очереди для отправки сообщения
    static final String queueName = "personal-finance";

    @Bean
    Queue queue() {
        return new Queue(queueName, false);
    }

    @Bean
    TopicExchange exchange() {
        return new TopicExchange(topicExchangeName);
    }

    public static void main(String[] args) throws InterruptedException {
        SpringApplication.run(Application.class, args).close();
    }
}
```

В ресурсах создайте файл `application.properties` и добавьте следующее содержимое:

```
# Адрес для соединения
spring.rabbitmq.host=localhost
# Логин для соединения
spring.rabbitmq.username=guest
# Пароль для соединения
spring.rabbitmq.password=guest
# Порт для соединения
spring.rabbitmq.port=5672
# Виртуальный хост для соединения
spring.rabbitmq.virtual-host=/
```

Создайте _DTO_ для формирования JSON представления сообщения:

```java
package io.github.personal_finance.dto;

import java.io.Serializable;
import java.math.BigDecimal;

public class ExpenseCreateInfo implements Serializable {

    private Long categoryId;
    private BigDecimal amount;
    private Long userId;

    public ExpenseCreateInfo() {
    }

    public ExpenseCreateInfo(Long categoryId, BigDecimal amount, Long userId) {
        this.categoryId = categoryId;
        this.amount = amount;
        this.userId = userId;
    }

    public Long getCategoryId() {
        return categoryId;
    }

    public void setCategoryId(Long categoryId) {
        this.categoryId = categoryId;
    }

    public BigDecimal getAmount() {
        return amount;
    }

    public void setAmount(BigDecimal amount) {
        this.amount = amount;
    }

    public Long getUserId() {
        return userId;
    }

    public void setUserId(Long userId) {
        this.userId = userId;
    }
}
```

Затем создайте класс отправки сообщения `Run.java`:

```java
package io.github.personal_finance;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.github.personal_finance.dto.ExpenseCreateInfo;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.math.BigDecimal;

@Component
public class Runner implements CommandLineRunner {

    private final RabbitTemplate rabbitTemplate;

    @Autowired
    public Runner(RabbitTemplate rabbitTemplate) {
        this.rabbitTemplate = rabbitTemplate;
    }

    @Override
    public void run(String... args) throws Exception {
// Создание мапера для вызова Jackson
        ObjectMapper mapper = new ObjectMapper();
// Инициализация DTO  
        ExpenseCreateInfo expenseCreateInfo = new ExpenseCreateInfo(1L, BigDecimal.valueOf(100), 1L);
// Конвертация POJO в JSON представление
        String expenseJsonRepresentation = mapper.writeValueAsString(expenseCreateInfo);
// Отправка сообщения в очередь RabbitMQ
        rabbitTemplate.convertAndSend(Application.topicExchangeName, expenseJsonRepresentation);
    }
}
```

В панели администрирования можно проверить наличие сообщения:

![rabbitmq](https://media.githubusercontent.com/media/rmuhamedgaliev-mkdev/quest-static/master/rabbitmq-quest-management.jpg)

Теперь необходимо прочитать этот сообщение в основной программе.

Измените `build.gradle` в корневом проекте и добавьте RabbitMQ зависимости:

```groovy

plugins {
    id "java"
    id "application"
    id "org.springframework.boot" version "2.1.0.RELEASE"
    id "io.spring.dependency-management" version "1.0.6.RELEASE"
}

mainClassName = "io.github.io.github.personal_finance.App"


bootJar {
    baseName = "personal-finance-service"
    version = "0.0.1"
}

sourceCompatibility = 11
targetCompatibility = 11

repositories {
    jcenter()
}

ext {
    hibernateV = "5.4.0.Final"
    jacksonV = "2.9.8"
    guavaV = "23.0"
}

dependencies {
    implementation "com.google.guava:guava:${guavaV}"
    implementation "org.springframework.boot:spring-boot-starter-web"


    implementation "org.hibernate:hibernate-core:${hibernateV}"
    implementation "org.springframework.boot:spring-boot-starter-data-jpa"
    implementation "org.springframework.boot:spring-boot-starter-amqp"

    implementation "com.fasterxml.jackson.core:jackson-core:${jacksonV}"
    implementation "com.fasterxml.jackson.core:jackson-annotations:${jacksonV}"
    implementation "com.fasterxml.jackson.core:jackson-databind:${jacksonV}"

    // Use JUnit test framework
    testImplementation "org.springframework.boot:spring-boot-starter-test"
    testImplementation "junit:junit:4.12"
    runtime("org.postgresql:postgresql")
}



wrapper {
    gradleVersion = "5.1.1" // Желаемая версия
}
```

Обновляем `App.java` и добавляем конфигурацию для подключения очереди:

```java
    static final String topicExchangeName = "personal-finance";
    static final String queueName = "personal-finance";

    public static void main(String[] args) {
        SpringApplication.run(App.class, args);
    }

    @Bean
    Queue queue() {
        return new Queue(queueName, false);
    }

    @Bean
    TopicExchange exchange() {
        return new TopicExchange(topicExchangeName);
    }

    @Bean
    Binding binding(Queue queue, TopicExchange exchange) {
        return BindingBuilder.bind(queue).to(exchange).with("foo.bar.#");
    }

    @Bean
    SimpleMessageListenerContainer container(ConnectionFactory connectionFactory,
                                             MessageListenerAdapter listenerAdapter) {
        SimpleMessageListenerContainer container = new SimpleMessageListenerContainer();
        container.setConnectionFactory(connectionFactory);
        container.setQueueNames(queueName);
        container.setMessageListener(listenerAdapter);
        return container;
    }

    @Bean
    MessageListenerAdapter listenerAdapter(ExpenseReceiver receiver) {
        return new MessageListenerAdapter(receiver, "receiveMessage");
    }
```

Добавьте в файл `application.properties` следующее содержимое:

```
# Адрес для соединения
spring.rabbitmq.host=localhost
# Логин для соединения
spring.rabbitmq.username=guest
# Пароль для соединения
spring.rabbitmq.password=guest
# Порт для соединения
spring.rabbitmq.port=5672
# Виртуальный хост для соединения
spring.rabbitmq.virtual-host=/
```

Создайте класс который будет принимать сообщения из RabbitMQ и записывать траты в БД:

```java
package io.github.personal_finance.receiver;

import com.fasterxml.jackson.databind.ObjectMapper;
import io.github.personal_finance.controller.dto.ExpenceCreateInfo;
import io.github.personal_finance.domain.Category;
import io.github.personal_finance.domain.Expense;
import io.github.personal_finance.domain.User;
import io.github.personal_finance.repository.CategoryRepository;
import io.github.personal_finance.repository.ExpenseRepository;
import io.github.personal_finance.repository.UsersRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.IOException;

@Component
public class ExpenseReceiver {

    private final ExpenseRepository expenseRepository;
    private final CategoryRepository categoryRepository;
    private final UsersRepository usersRepository;

    @Autowired
    public ExpenseReceiver(ExpenseRepository expenseRepository, CategoryRepository categoryRepository, UsersRepository usersRepository) {
        this.expenseRepository = expenseRepository;
        this.categoryRepository = categoryRepository;
        this.usersRepository = usersRepository;
    }

    public void receiveMessage(String message) throws IOException {
        ObjectMapper mapper = new ObjectMapper();
        ExpenceCreateInfo expenceCreateInfo = mapper.readValue(message, ExpenceCreateInfo.class);
        Category category = this.categoryRepository.findCategoryById(expenceCreateInfo.getCategoryId());
        User user = this.usersRepository.findUserById(expenceCreateInfo.getUserId());
        Expense expense = new Expense(category, user, expenceCreateInfo.getAmount());
        this.expenseRepository.save(expense);
    }
}
```

В результате, вы должны послать сообщение в клиентском приложении и получив на серверной части приложения сохранить запись в БД.

## Задание

- Организовать пересылку сообщений посредством RabbitMQ
- Реализовать в клиентском приложении ввод аргументов по средством аргументов командной строки. (https://dzone.com/articles/spring-boot-applicationrunner-and-commandlinerunne , https://leodev.ru/blog/spring-boot/spring-boot-commandlinerunner/#.XF9T6y2B1bU)
- Реализовать обработку ошибок при различных ситуация
- Написать тесты на обрабтку всех сущностей (CRUD операции) при помощи mock репозиториев (https://dzone.com/articles/spring-boot-unit-testing-and-mocking-with-mockito)
- Реализовать в клиентском приложении запрос баланса пользователя по средством RabbitMQ

## Материалы по теме

- https://habr.com/ru/post/262069/
- https://spring.io/guides/gs/messaging-rabbitmq/
- https://docs.spring.io/spring-amqp/docs/2.1.3.RELEASE/reference/html/



